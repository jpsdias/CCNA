---
- name: Deploy Security L2 Access Switches
  hosts: access_switches
  gather_facts: no

  tasks:
    - name: Apply port-security on access ports in VLANs 10, 20, 30
      cisco.ios.ios_config:
        parents: "interface {{ item.name }}"
        lines:
          - switchport port-security
          - switchport port-security maximum 5
          - switchport port-security violation shutdown
          - switchport port-security aging time 5
          - switchport port-security aging type inactivity
      loop: "{{ l2_interfaces }}"
      when:
        - item.access is defined
        - item.access.vlan in [10, 20, 30]
      tags: port_security

    - name: Enable DHCP snooping globally
      cisco.ios.ios_config:
        lines:
          - ip dhcp snooping
      tags: dhcp_snooping

    - name: Enable DHCP snooping for all relevant VLANs
      cisco.ios.ios_config:
        lines:
          - "ip dhcp snooping vlan {{ vlans | rejectattr('id', 'equalto', 99) | map(attribute='id') | join(',') }}"
      tags: dhcp_snooping

    - name: Configure trusted ports for DHCP server and MLSs
      cisco.ios.ios_config:
        parents: "interface {{ item.name }}"
        lines:
          - ip dhcp snooping trust
      loop: "{{ l2_interfaces }}"
      when:
        - trusted_ports is defined 
        - item.name in trusted_ports
      tags: dhcp_snooping

    - name: Configure rate-limiting on untrusted ports
      cisco.ios.ios_config:
        parents: "interface {{ item.name }}"
        lines:
          - ip dhcp snooping limit rate 5
      loop: "{{ l2_interfaces }}"
      when:
        - trusted_ports is defined 
        - item.name not in trusted_ports
      tags: dhcp_snooping

    - name: Enable Dynamic ARP Inspection on VLANs 10, 20, 30
      cisco.ios.ios_config:
        lines:
          - ip arp inspection vlan 10,20,30
      tags: dai
      
    - name: Configure ARP inspection rate limit on untrusted ports
      cisco.ios.ios_config:
        parents: "interface {{ item.name }}"
        lines:
          - ip arp inspection limit rate 15
      loop: "{{ l2_interfaces }}"
      when:
        - trusted_ports is defined
        - item.name not in trusted_ports
      tags: dai

    - name: Configure PortFast and BPDU Guard on all access ports
      cisco.ios.ios_config:
        parents: "interface {{ item.name }}"
        lines:
          - spanning-tree portfast
          - spanning-tree bpduguard enable
      loop: "{{ l2_interfaces }}"
      when:
        - item.access is defined
      tags: stp